



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Chapter 1 - Save-LoRa</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#chapter-1-hacking-gotham-citys-lora-network" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Save-LoRa" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Save-LoRa
            </span>
            <span class="md-header-nav__topic">
              Chapter 1
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Save-LoRa" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Save-LoRa
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Game Briefing" class="md-nav__link">
      Game Briefing
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Chapter 1
      </label>
    
    <a href="./" title="Chapter 1" class="md-nav__link md-nav__link--active">
      Chapter 1
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#briefing" title="Briefing" class="md-nav__link">
    Briefing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-goal" title="Main Goal" class="md-nav__link">
    Main Goal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-connecting-to-the-broker" title="Step 1 - Connecting to the Broker" class="md-nav__link">
    Step 1 - Connecting to the Broker
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-decoding-a-join-request" title="Step 2 - Decoding a Join Request" class="md-nav__link">
    Step 2 - Decoding a Join Request
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-21-joinrequestpacketdecoderissupported" title="Step 2.1 JoinRequestPacketDecoder.isSupported() ?" class="md-nav__link">
    Step 2.1 JoinRequestPacketDecoder.isSupported() ?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-22-joinrequestpacketdecoderdecode" title="Step 2.2 JoinRequestPacketDecoder.decode() ?" class="md-nav__link">
    Step 2.2 JoinRequestPacketDecoder.decode() ?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automated-activating-the-device" title="(Automated) Activating the device" class="md-nav__link">
    (Automated) Activating the device
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ch2-geek-victim/" title="Chapter 2" class="md-nav__link">
      Chapter 2
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#briefing" title="Briefing" class="md-nav__link">
    Briefing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-goal" title="Main Goal" class="md-nav__link">
    Main Goal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-connecting-to-the-broker" title="Step 1 - Connecting to the Broker" class="md-nav__link">
    Step 1 - Connecting to the Broker
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-decoding-a-join-request" title="Step 2 - Decoding a Join Request" class="md-nav__link">
    Step 2 - Decoding a Join Request
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-21-joinrequestpacketdecoderissupported" title="Step 2.1 JoinRequestPacketDecoder.isSupported() ?" class="md-nav__link">
    Step 2.1 JoinRequestPacketDecoder.isSupported() ?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-22-joinrequestpacketdecoderdecode" title="Step 2.2 JoinRequestPacketDecoder.decode() ?" class="md-nav__link">
    Step 2.2 JoinRequestPacketDecoder.decode() ?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automated-activating-the-device" title="(Automated) Activating the device" class="md-nav__link">
    (Automated) Activating the device
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="chapter-1-hacking-gotham-citys-lora-network">Chapter 1: Hacking Gotham City's LoRa Network</h1>
<h2 id="briefing">Briefing</h2>
<p>Your name is Trinity.<br />
You are the one who sent the message to your friend John.<br />
You are leading a community of hackers. 
By chance, you were outside when the earthquake happened and you are fine. 
Your computer gear as well, thanks for asking.  </p>
<p>Your city (Gotham) has a network of <strong>LoRa-nodes</strong> and <strong>Gateways</strong> which receive sensor-data from hundreds of devices spread across the region.<br />
This data is then processed by the city council main LoRa App Server, called Gotham-IoT, which manages all device-authorization and exposes a REST &amp; gRPC API for back-office apps used by the city council.  </p>
<p>As all the security systems are down, you made your way inside the City Council building and managed to get into the DMZ.
You are connected to the production private network, still running on batteries.</p>
<p>After looking around, you found
 * an unrestricted access to the City's MQTT broker, the one which gets ALL LoRa trafic.
 * a restricted but insecure access to the Gotham-IoT server that manages all device-authorization / messaging of the network.</p>
<h2 id="main-goal">Main Goal</h2>
<p>Your main goal is to allow your friend to send his Geo-Location via a LoRa packet.<br />
Once you have this, you can alert the local authorities and get him safe.</p>
<p>However, there are a few issues :
 * Devices follow a specific activation process and people can't just emit packets on the network.
 * Once devices are activated, sending data must follow a specific protocol and can't just be sent in plain text.</p>
<p>Your mission, if you accept it, will be to <strong>tap into</strong> the <strong>MQTT broker</strong> and listen to all the packets, 
<strong>identify</strong> your device attempts to Join the network (<strong>JoinRequest</strong>), and <strong>use</strong> your access to the <strong>Gotham-IoT server</strong> to register it <strong>yourself</strong>. </p>
<ul>
<li><strong>Step 1</strong>: connect to the remote MQTT broker and subscribe to all topics using a wildcard.</li>
<li><strong>Step 2</strong>: decode a join-request</li>
<li><strong>Step 3</strong>: if the join-request has the right identifier (that only you and your friends know), make it join the network. </li>
</ul>
<p><strong>Guidelines:</strong><br />
We provided you with boilerplate code, you are supposed to implement all functions which contain a <code>//TODO</code>.<br />
The package <code>noedit</code> is used internally and... not meant to be edited.    </p>
<p><strong>Important:</strong><br />
To <strong>validate</strong> your steps (and win points), your app needs to be <strong>running</strong>!
Don't forget to run using <strong>npm start</strong> or <strong>npm serve</strong>.</p>
<h2 id="step-1-connecting-to-the-broker">Step 1 - Connecting to the Broker</h2>
<p>The MQTT broker is exposed on a public URL, and you have managed to get an access to it after hacking the email account of the sysadmin. All the credentials are in the conf.js file.<br />
MQTT is a typical messaging protocol particularly used for IoT. 
To subscribe to all topics, you may have to use a <strong>wildcard</strong>...<br />
We have provided a MQTT client, take a look at their official doc here: <a href="https://github.com/mqttjs/MQTT.js">https://github.com/mqttjs/MQTT.js</a></p>
<ol>
<li>Connect to the MQTT Broker</li>
<li>Subscribe to all topics</li>
</ol>
<p><strong>Important:</strong>  </p>
<p>Hint 1:<br />
All the code you need to implement is in <strong>chapter1/src/tobeimpl/step-1</strong></p>
<p>Hint 2:  <br />
To connect to the broker, don't forget to use <strong>all</strong> the parameters provided in conf.js: conf.mqtt.host, conf.mqtt.username, conf.mqtt.password, conf.mqtt.clientId</p>
<p>Hint 3:  <br />
You will <strong>NOT</strong> need the manuals for this step</p>
<h2 id="step-2-decoding-a-join-request">Step 2 - Decoding a Join Request</h2>
<p>Now that you are receiving all the messages of all the gateways, you start noticing that there are multiple types of messages and structures.
Some of them are encrypted, some others are not.<br />
Before they can start sharing data on a Network, the devices follow an activation process called OTAA (Over-The-Air Activation).<br />
We will look into the process later. For now the only thing you need to know is the following:  </p>
<p>When a device attempts to join a LoRaNetwork, it sends JoinRequests.<br />
A JoinRequest contains:</p>
<ul>
<li>its <strong>unique ID</strong> called Device EUI or DevEUI (&lt;=&gt; Mac Address)</li>
<li>a target <strong>Application ID</strong> (see it as a <strong>Realm</strong>)</li>
<li>other info (DevNOnce, MIC) that we won't worry about today...</li>
</ul>
<p>The good thing about JoinRequests is that they are <strong>not</strong> Encrypted.<br />
That means we can easily decode them from the MQTT broker packets!  </p>
<p>To understand how to spot a Join Request, you need to read the binary protocol used to encode the payload. You should read your LoRaWAN 101 course... <a href="/resources/course/lorawan-101-course.md">Here's a link if you don't have it</a>.</p>
<p>The file you will need to modify is in <strong>chapter1/src/step-2/JoinRequestPacketDecoderecoder.js</strong></p>
<ol>
<li>Implement the <code>chapter1/src/step-2/JoinRequestPacketDecoder.isSupported()</code> method</li>
<li>Implement the <code>chapter1/src/step-2/JoinRequestPacketDecoder.decode()</code> method</li>
</ol>
<p><strong>Tests:</strong></p>
<p>To make your life easier, we have implemented a sequence of tests to validate these two points.<br />
Just run <code>npm test</code> and it should give you a good way to see whether your implementation of both methods is right or not.</p>
<p>The test file is available in <strong>chapter1/src/step-2/JoinRequestPacketDecoder.spec.js</strong> for reference.</p>
<p><strong>Important:</strong>
ONLY implement Step 2.1 (<code>isSupported()</code>)first. Then worry about Step 2.2. It will give you <strong>more</strong> points.</p>
<h3 id="step-21-joinrequestpacketdecoderissupported">Step 2.1 JoinRequestPacketDecoder.isSupported() ?</h3>
<p><strong>How to spot a JoinRequest:</strong><br />
  A join request can be recognized by the following:</p>
<ul>
<li>the message has a string field called "phyPayload" containing <strong>base64 encoded data</strong> </li>
<li>the binary message of phyPayload has the following Mac Header (first byte of phyPayload): <strong>0b00000000</strong></li>
</ul>
<p><strong>Important:</strong></p>
<p>Hint 1:<br />
Don't forget that we have already deserialized the base64 string payload into a byte Buffer! 
In the decode() method, <strong>this.payload</strong> refers to the ByteBuffer containing your payload.</p>
<p>Hint 2:<br />
We highly advise you to take a look at the <a href="https://nodejs.org/api/buffer.html">Node Buffer documentation</a>. <br />
It contains cool methods like <strong>buffer.readXXX</strong> for instance.</p>
<p>Hint 3:<br />
You will need the <strong>LoRa 101 Course</strong> manual.</p>
<h3 id="step-22-joinrequestpacketdecoderdecode">Step 2.2 JoinRequestPacketDecoder.decode() ?</h3>
<p>Now that you have found which Packets are JoinRequests, you need to extract its metadata from the binary buffer.</p>
<p>We are looking for the AppEUI, the DevEUI, the DevNOnce and the MIC.  </p>
<p><strong>Important:</strong>   </p>
<p>Hint 1:<br />
Don't forget that we have already deserialized the base64 string payload into a byte Buffer! 
In the decode() method, <strong>this.payload</strong> refers to the ByteBuffer containing your payload.</p>
<p>Hint 2:<br />
We highly advise you to take a look at the <a href="https://nodejs.org/api/buffer.html">Node Buffer documentation</a>. <br />
It contains cool methods like <strong>buffer.readInt8</strong> or <strong>buffer.readUInt8</strong> for instance.</p>
<p>Hint 3:<br />
Your friends all bought the same LoRa Device which is from the manufacturer Unicorn Inc.<br />
The Manufacturer's DevEUI (&lt;=&gt; MAC Address) all start with <strong>13:37:00:00</strong>:XX:XX:XX:XX</p>
<p>Hint 4:<br />
The PhyPayload binary protocol stores information in... Little-Endian... <a href="https://en.wikipedia.org/wiki/Endianness">https://en.wikipedia.org/wiki/Endianness</a>. Most payloads are <strong>unsigned</strong>. </p>
<h2 id="automated-activating-the-device">(Automated) Activating the device</h2>
<p>Now that we know how to decode a Device JoinRequest, Neo (your sidekick) will implement the necessary steps to activation in the Gotham-IoT server.  </p>
<p>The OTAA concept is very simple:</p>
<ul>
<li>The device sends a JoinRequest containing its <strong>unique ID</strong> called Device EUI or DevEUI (&lt;=&gt; Mac Address), the <strong>Application ID</strong>, and other info (DevNOnce, MIC).</li>
<li>The Gotham-IoT server checks if the Application has registered the current Device.</li>
<li>If the device exists, it will send a JoinAccept response.</li>
<li>The GothamIoT server needs to generate a Network Key called NwkKey (it's like a 16-byte <strong>token</strong> set by the Gotham-IoT admin to authenticate your device)</li>
<li>After this, the device needs to set the Network Key for all exchanges. </li>
</ul>
<p>You can find more info on it here: <a href="http://www.techplayon.com/lora-device-activation-call-flow-join-procedure-using-otaa-and-abp">http://www.techplayon.com/lora-device-activation-call-flow-join-procedure-using-otaa-and-abp</a></p>
<p>Your friend Neo has already created a client allowing you to authenticate and communicate with the Gotham-IoT Server.</p>
<p>He will use your code and :</p>
<ol>
<li>Take the decoded packet and use DevEUI and AppEUI to check if device exists in App.</li>
<li>If device does not exist, create it</li>
<li>Change the Device NwkKey to <code>42:42:42:42:42:42:42:42:42:42:42:42:42:42:42:42</code></li>
</ol>
<p>Congratulations. You guys made it! We only need to wait for John's sign.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Game Briefing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Game Briefing
              </span>
            </div>
          </a>
        
        
          <a href="../ch2-geek-victim/" title="Chapter 2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Chapter 2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>